{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n\n    if (enumerableOnly) {\n      symbols = symbols.filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n      });\n    }\n\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n} // Copyright 2017-2021 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\n\nimport BN from 'bn.js';\nimport { bnMax, isFunction } from '@polkadot/util';\nimport { combineLatest, of } from '@polkadot/x-rxjs';\nimport { map, switchMap } from '@polkadot/x-rxjs/operators';\nimport { memo } from \"../util/index.js\";\nconst VESTING_ID = '0x76657374696e6720';\n\nfunction calcLocked(api, bestNumber, locks) {\n  let lockedBalance = api.registry.createType('Balance');\n  let lockedBreakdown = [];\n  let vestingLocked = api.registry.createType('Balance');\n  let allLocked = false;\n\n  if (Array.isArray(locks)) {\n    // only get the locks that are valid until passed the current block\n    lockedBreakdown = locks.filter(({\n      until\n    }) => !until || bestNumber && until.gt(bestNumber));\n    allLocked = lockedBreakdown.some(({\n      amount\n    }) => amount && amount.isMax());\n    vestingLocked = api.registry.createType('Balance', lockedBreakdown.filter(({\n      id\n    }) => id.eq(VESTING_ID)).reduce((result, {\n      amount\n    }) => result.iadd(amount), new BN(0))); // get the maximum of the locks according to https://github.com/paritytech/substrate/blob/master/srml/balances/src/lib.rs#L699\n\n    const notAll = lockedBreakdown.filter(({\n      amount\n    }) => amount && !amount.isMax());\n\n    if (notAll.length) {\n      lockedBalance = api.registry.createType('Balance', bnMax(...notAll.map(({\n        amount\n      }) => amount)));\n    }\n  }\n\n  return {\n    allLocked,\n    lockedBalance,\n    lockedBreakdown,\n    vestingLocked\n  };\n}\n\nfunction calcShared(api, bestNumber, data, locks) {\n  const {\n    allLocked,\n    lockedBalance,\n    lockedBreakdown,\n    vestingLocked\n  } = calcLocked(api, bestNumber, locks);\n  return _objectSpread(_objectSpread({}, data), {}, {\n    availableBalance: api.registry.createType('Balance', allLocked ? 0 : bnMax(new BN(0), data.freeBalance.sub(lockedBalance))),\n    lockedBalance,\n    lockedBreakdown,\n    vestingLocked\n  });\n}\n\nfunction calcBalances(api, [data, bestNumber, [vesting, allLocks]]) {\n  const shared = calcShared(api, bestNumber, data, allLocks[0]); // Calculate the vesting balances,\n  //  - offset = balance locked at startingBlock\n  //  - perBlock is the unlock amount\n\n  const {\n    locked: vestingTotal,\n    perBlock,\n    startingBlock\n  } = vesting || api.registry.createType('VestingInfo');\n  const isStarted = bestNumber.gt(startingBlock);\n  const vestedNow = isStarted ? perBlock.mul(bestNumber.sub(startingBlock)) : new BN(0);\n  const vestedBalance = vestedNow.gt(vestingTotal) ? vestingTotal : api.registry.createType('Balance', vestedNow);\n  const isVesting = isStarted && !shared.vestingLocked.isZero();\n  return _objectSpread(_objectSpread({}, shared), {}, {\n    accountId: data.accountId,\n    accountNonce: data.accountNonce,\n    additional: allLocks.filter((_, index) => index !== 0).map((l, index) => calcShared(api, bestNumber, data.additional[index], l)),\n    isVesting,\n    vestedBalance,\n    vestedClaimable: api.registry.createType('Balance', isVesting ? shared.vestingLocked.sub(vestingTotal.sub(vestedBalance)) : 0),\n    vestingEndBlock: api.registry.createType('BlockNumber', isVesting ? vestingTotal.div(perBlock).add(startingBlock) : 0),\n    vestingPerBlock: perBlock,\n    vestingTotal\n  });\n} // old\n\n\nfunction queryOld(api, accountId) {\n  return api.queryMulti([[api.query.balances.locks, accountId], [api.query.balances.vesting, accountId]]).pipe(map(([locks, optVesting]) => {\n    let vestingNew = null;\n\n    if (optVesting.isSome) {\n      const {\n        offset: locked,\n        perBlock,\n        startingBlock\n      } = optVesting.unwrap();\n      vestingNew = api.registry.createType('VestingInfo', {\n        locked,\n        perBlock,\n        startingBlock\n      });\n    }\n\n    return [vestingNew, [locks]];\n  }));\n}\n\nconst isNonNullable = nullable => !!nullable; // current (balances, vesting)\n\n\nfunction queryCurrent(api, accountId, balanceInstances = ['balances']) {\n  var _api$query$vesting;\n\n  const lockCalls = balanceInstances.map(m => {\n    var _m, _api$query;\n\n    return ((_m = api.derive[m]) === null || _m === void 0 ? void 0 : _m.customLocks) || ((_api$query = api.query[m]) === null || _api$query === void 0 ? void 0 : _api$query.locks);\n  });\n  const lockEmpty = lockCalls.map(c => !c);\n  const lockQueries = lockCalls.filter(isNonNullable).map(c => [c, accountId]);\n  return ((_api$query$vesting = api.query.vesting) !== null && _api$query$vesting !== void 0 && _api$query$vesting.vesting ? api.queryMulti([[api.query.vesting.vesting, accountId], ...lockQueries]) // TODO We need to check module instances here as well, not only the balances module\n  : lockQueries.length ? api.queryMulti(lockQueries).pipe(map(locks => [api.registry.createType('Option<VestingInfo>'), ...locks])) : of([api.registry.createType('Option<VestingInfo>')])).pipe(map(([optVesting, ...locks]) => {\n    let offset = -1;\n    return [optVesting.unwrapOr(null), lockEmpty.map(e => e ? api.registry.createType('Vec<BalanceLock>') : locks[++offset])];\n  }));\n}\n/**\n * @name all\n * @param {( AccountIndex | AccountId | Address | string )} address - An accounts Id in different formats.\n * @returns An object containing the results of various balance queries\n * @example\n * <BR>\n *\n * ```javascript\n * const ALICE = 'F7Hs';\n *\n * api.derive.balances.all(ALICE, ({ accountId, lockedBalance }) => {\n *   console.log(`The account ${accountId} has a locked balance ${lockedBalance} units.`);\n * });\n * ```\n */\n\n\nexport function all(instanceId, api) {\n  const balanceInstances = api.registry.getModuleInstances(api.runtimeVersion.specName.toString(), 'balances');\n  return memo(instanceId, address => api.derive.balances.account(address).pipe(switchMap(account => {\n    var _api$query$system, _api$query$balances;\n\n    return !account.accountId.isEmpty ? combineLatest([of(account), api.derive.chain.bestNumber(), isFunction((_api$query$system = api.query.system) === null || _api$query$system === void 0 ? void 0 : _api$query$system.account) || isFunction((_api$query$balances = api.query.balances) === null || _api$query$balances === void 0 ? void 0 : _api$query$balances.account) ? queryCurrent(api, account.accountId, balanceInstances) : queryOld(api, account.accountId)]) : of([account, api.registry.createType('BlockNumber'), [null, []]]);\n  }), map(result => calcBalances(api, result))));\n}","map":{"version":3,"sources":["/home/wirednkod/Documents/repos/mine/sampleContext/node_modules/@polkadot/api-derive/balances/all.js"],"names":["_defineProperty","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","defineProperty","BN","bnMax","isFunction","combineLatest","of","map","switchMap","memo","VESTING_ID","calcLocked","api","bestNumber","locks","lockedBalance","registry","createType","lockedBreakdown","vestingLocked","allLocked","Array","isArray","until","gt","some","amount","isMax","id","eq","reduce","result","iadd","notAll","calcShared","data","availableBalance","freeBalance","sub","calcBalances","vesting","allLocks","shared","locked","vestingTotal","perBlock","startingBlock","isStarted","vestedNow","mul","vestedBalance","isVesting","isZero","accountId","accountNonce","additional","_","index","l","vestedClaimable","vestingEndBlock","div","add","vestingPerBlock","queryOld","queryMulti","query","balances","pipe","optVesting","vestingNew","isSome","offset","unwrap","isNonNullable","nullable","queryCurrent","balanceInstances","_api$query$vesting","lockCalls","m","_m","_api$query","derive","customLocks","lockEmpty","c","lockQueries","unwrapOr","e","all","instanceId","getModuleInstances","runtimeVersion","specName","toString","address","account","_api$query$system","_api$query$balances","isEmpty","chain","system"],"mappings":"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","sourcesContent":["import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n// Copyright 2017-2021 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\nimport BN from 'bn.js';\nimport { bnMax, isFunction } from '@polkadot/util';\nimport { combineLatest, of } from '@polkadot/x-rxjs';\nimport { map, switchMap } from '@polkadot/x-rxjs/operators';\nimport { memo } from \"../util/index.js\";\nconst VESTING_ID = '0x76657374696e6720';\n\nfunction calcLocked(api, bestNumber, locks) {\n  let lockedBalance = api.registry.createType('Balance');\n  let lockedBreakdown = [];\n  let vestingLocked = api.registry.createType('Balance');\n  let allLocked = false;\n\n  if (Array.isArray(locks)) {\n    // only get the locks that are valid until passed the current block\n    lockedBreakdown = locks.filter(({\n      until\n    }) => !until || bestNumber && until.gt(bestNumber));\n    allLocked = lockedBreakdown.some(({\n      amount\n    }) => amount && amount.isMax());\n    vestingLocked = api.registry.createType('Balance', lockedBreakdown.filter(({\n      id\n    }) => id.eq(VESTING_ID)).reduce((result, {\n      amount\n    }) => result.iadd(amount), new BN(0))); // get the maximum of the locks according to https://github.com/paritytech/substrate/blob/master/srml/balances/src/lib.rs#L699\n\n    const notAll = lockedBreakdown.filter(({\n      amount\n    }) => amount && !amount.isMax());\n\n    if (notAll.length) {\n      lockedBalance = api.registry.createType('Balance', bnMax(...notAll.map(({\n        amount\n      }) => amount)));\n    }\n  }\n\n  return {\n    allLocked,\n    lockedBalance,\n    lockedBreakdown,\n    vestingLocked\n  };\n}\n\nfunction calcShared(api, bestNumber, data, locks) {\n  const {\n    allLocked,\n    lockedBalance,\n    lockedBreakdown,\n    vestingLocked\n  } = calcLocked(api, bestNumber, locks);\n  return _objectSpread(_objectSpread({}, data), {}, {\n    availableBalance: api.registry.createType('Balance', allLocked ? 0 : bnMax(new BN(0), data.freeBalance.sub(lockedBalance))),\n    lockedBalance,\n    lockedBreakdown,\n    vestingLocked\n  });\n}\n\nfunction calcBalances(api, [data, bestNumber, [vesting, allLocks]]) {\n  const shared = calcShared(api, bestNumber, data, allLocks[0]); // Calculate the vesting balances,\n  //  - offset = balance locked at startingBlock\n  //  - perBlock is the unlock amount\n\n  const {\n    locked: vestingTotal,\n    perBlock,\n    startingBlock\n  } = vesting || api.registry.createType('VestingInfo');\n  const isStarted = bestNumber.gt(startingBlock);\n  const vestedNow = isStarted ? perBlock.mul(bestNumber.sub(startingBlock)) : new BN(0);\n  const vestedBalance = vestedNow.gt(vestingTotal) ? vestingTotal : api.registry.createType('Balance', vestedNow);\n  const isVesting = isStarted && !shared.vestingLocked.isZero();\n  return _objectSpread(_objectSpread({}, shared), {}, {\n    accountId: data.accountId,\n    accountNonce: data.accountNonce,\n    additional: allLocks.filter((_, index) => index !== 0).map((l, index) => calcShared(api, bestNumber, data.additional[index], l)),\n    isVesting,\n    vestedBalance,\n    vestedClaimable: api.registry.createType('Balance', isVesting ? shared.vestingLocked.sub(vestingTotal.sub(vestedBalance)) : 0),\n    vestingEndBlock: api.registry.createType('BlockNumber', isVesting ? vestingTotal.div(perBlock).add(startingBlock) : 0),\n    vestingPerBlock: perBlock,\n    vestingTotal\n  });\n} // old\n\n\nfunction queryOld(api, accountId) {\n  return api.queryMulti([[api.query.balances.locks, accountId], [api.query.balances.vesting, accountId]]).pipe(map(([locks, optVesting]) => {\n    let vestingNew = null;\n\n    if (optVesting.isSome) {\n      const {\n        offset: locked,\n        perBlock,\n        startingBlock\n      } = optVesting.unwrap();\n      vestingNew = api.registry.createType('VestingInfo', {\n        locked,\n        perBlock,\n        startingBlock\n      });\n    }\n\n    return [vestingNew, [locks]];\n  }));\n}\n\nconst isNonNullable = nullable => !!nullable; // current (balances, vesting)\n\n\nfunction queryCurrent(api, accountId, balanceInstances = ['balances']) {\n  var _api$query$vesting;\n\n  const lockCalls = balanceInstances.map(m => {\n    var _m, _api$query;\n\n    return ((_m = api.derive[m]) === null || _m === void 0 ? void 0 : _m.customLocks) || ((_api$query = api.query[m]) === null || _api$query === void 0 ? void 0 : _api$query.locks);\n  });\n  const lockEmpty = lockCalls.map(c => !c);\n  const lockQueries = lockCalls.filter(isNonNullable).map(c => [c, accountId]);\n  return ((_api$query$vesting = api.query.vesting) !== null && _api$query$vesting !== void 0 && _api$query$vesting.vesting ? api.queryMulti([[api.query.vesting.vesting, accountId], ...lockQueries]) // TODO We need to check module instances here as well, not only the balances module\n  : lockQueries.length ? api.queryMulti(lockQueries).pipe(map(locks => [api.registry.createType('Option<VestingInfo>'), ...locks])) : of([api.registry.createType('Option<VestingInfo>')])).pipe(map(([optVesting, ...locks]) => {\n    let offset = -1;\n    return [optVesting.unwrapOr(null), lockEmpty.map(e => e ? api.registry.createType('Vec<BalanceLock>') : locks[++offset])];\n  }));\n}\n/**\n * @name all\n * @param {( AccountIndex | AccountId | Address | string )} address - An accounts Id in different formats.\n * @returns An object containing the results of various balance queries\n * @example\n * <BR>\n *\n * ```javascript\n * const ALICE = 'F7Hs';\n *\n * api.derive.balances.all(ALICE, ({ accountId, lockedBalance }) => {\n *   console.log(`The account ${accountId} has a locked balance ${lockedBalance} units.`);\n * });\n * ```\n */\n\n\nexport function all(instanceId, api) {\n  const balanceInstances = api.registry.getModuleInstances(api.runtimeVersion.specName.toString(), 'balances');\n  return memo(instanceId, address => api.derive.balances.account(address).pipe(switchMap(account => {\n    var _api$query$system, _api$query$balances;\n\n    return !account.accountId.isEmpty ? combineLatest([of(account), api.derive.chain.bestNumber(), isFunction((_api$query$system = api.query.system) === null || _api$query$system === void 0 ? void 0 : _api$query$system.account) || isFunction((_api$query$balances = api.query.balances) === null || _api$query$balances === void 0 ? void 0 : _api$query$balances.account) ? queryCurrent(api, account.accountId, balanceInstances) : queryOld(api, account.accountId)]) : of([account, api.registry.createType('BlockNumber'), [null, []]]);\n  }), map(result => calcBalances(api, result))));\n}"]},"metadata":{},"sourceType":"module"}